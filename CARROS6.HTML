                } // End for loop

                // --- Save and Render ONLY if vehicles were added ---
                if (addedCount > 0) {
                    saveToLocalStorage();
                    renderTable();
                    showToast(`${addedCount} vehículos importados.`, "success", 5000);
                } else if (errorCount > 0 && addedCount === 0) {
                     showToast(`Importación fallida. ${errorCount} filas con errores graves.`, "error", 6000);
                } else if (addedCount === 0 && errorCount === 0) {
                    showToast("No se importaron nuevos vehículos (archivo vacío o solo encabezado).", "info");
                }

                 if (errors.length > 0 && errorCount === 0) { // Only warnings
                     showToast(`${errors.length} advertencias durante la importación (ver detalles).`, "warning", 6000);
                 } else if (errors.length > 0 && errorCount > 0 && addedCount > 0) { // Errors and warnings, but some added
                     showToast(`${addedCount} vehículos importados, con ${errors.length} errores/advertencias.`, "warning", 6000);
                 }


                // Display final results in modal
                let resultHTML = `<span style="color: var(--success-color);">${addedCount} vehículos agregados.</span><br>`;
                resultHTML += `<span style="color: ${errorCount > 0 ? 'var(--danger-color)' : 'var(--text-muted)'};">${errorCount} filas con errores graves (ignoradas).</span><br>`;
                const warningCount = errors.length - errorCount; // Warnings are errors not counted in errorCount
                 resultHTML += `<span style="color: ${warningCount > 0 ? 'var(--warning-color)' : 'var(--text-muted)'};">${warningCount} advertencias (datos inválidos corregidos/ignorados).</span>`;

                if (errors.length > 0) {
                     resultHTML += `<br><br><strong>Detalles:</strong><br><small>${errors.join('<br>')}</small>`;
                     console.warn("Import errors/warnings:", errors);
                }
                resultDiv.innerHTML = resultHTML;


            } catch (error) {
                console.error("Error fatal during CSV import:", error);
                resultDiv.innerHTML = `<span style="color: var(--danger-color);">Error fatal durante la importación: ${error.message}. Revisa el archivo CSV y la consola (F12).</span>`;
                showToast("Error grave durante la importación.", "error");
            }
        };

        reader.onerror = function(e) {
            console.error("Error reading file:", e);
            resultDiv.innerHTML = '<span style="color: var(--danger-color);">Error al leer el archivo seleccionado.</span>';
            showToast("Error al leer el archivo.", "error");
        };

        reader.readAsText(file, 'UTF-8'); // Specify UTF-8 encoding
    }

    // Function to escape CSV data (basic quoting)
    function escapeCsvValue(value) {
        const strValue = (value === null || value === undefined) ? "" : String(value);
        // Quote if it contains comma, newline, or double quote
        if (/[,"\n]/.test(strValue)) {
            return `"${strValue.replace(/"/g, '""')}"`; // Escape internal quotes by doubling them
        }
        return strValue;
    }

    function exportData() {
        if (!Array.isArray(vehicles) || vehicles.length === 0) {
            showToast("No hay vehículos para exportar.", "info");
            return;
        }

        const headers = ["MarcaModelo", "Modelo", "Año", "Color", "Placas", "NumeroSerie", "FechaAdquisicion", "Kilometraje", "ProximoMantenimiento", "CambioPlacas", "VencimientoSeguro", "Aseguradora", "TelefonoSeguro", "RefrendoAnioPagado", "Observaciones", "LastVerificationDate"];
        let csvContent = headers.join(',') + '\r\n'; // Header row

        try {
            vehicles.forEach(veh => {
                const row = [
                    escapeCsvValue(veh.marcaModelo),
                    escapeCsvValue(veh.modelo),
                    escapeCsvValue(veh.año),
                    escapeCsvValue(veh.color),
                    escapeCsvValue(veh.placas),
                    escapeCsvValue(veh.numeroSerie),
                    escapeCsvValue(veh.fechaAdquisicion),
                    escapeCsvValue(veh.kilometraje),
                    escapeCsvValue(veh.proximoMantenimiento),
                    escapeCsvValue(veh.cambioPlacas),
                    escapeCsvValue(veh.vencimientoSeguro),
                    escapeCsvValue(veh.aseguradora),
                    escapeCsvValue(veh.telefono),
                    escapeCsvValue(veh.refrendoAnioPagado),
                    escapeCsvValue(veh.observaciones),
                    escapeCsvValue(veh.lastVerificationDate) // Export new field
                ];
                csvContent += row.join(',') + '\r\n';
            });

             // Add BOM for UTF-8 Excel compatibility
            const BOM = "\uFEFF";
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });

            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            const timestamp = new Date().toISOString().slice(0, 10); // YYYY-MM-DD

            link.setAttribute("href", url);
            link.setAttribute("download", `lefiocars_export_${timestamp}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url); // Clean up

            showToast("Datos exportados a CSV.", "success");

        } catch (error) {
             console.error("Error during CSV export:", error);
             showToast("Error al generar el archivo CSV.", "error");
        }
    }


    /* ========================================================================== */
    /*  14. GLOBAL ACTIONS & INITIALIZATION                                       */
    /* ========================================================================== */

    function saveAll() {
        // Explicitly trigger blur on any focused input inside modals or specific tables
        // This helps save changes made directly in tables (like state/license names)
        // before the global save.
         const activeInputs = document.querySelectorAll('#statesContainer input:focus, #licensesTableBody input:focus');
         activeInputs.forEach(input => input.blur());

        // Give a brief moment for blur events (like updatePersonName) to potentially trigger saveToLocalStorage
        setTimeout(() => {
            saveToLocalStorage();
            showToast("Cambios guardados.", "success");
        }, 50); // Short delay
    }

    function initializeApp() {
        console.log("Initializing LEFIOS CARS App v3.1..."); // Version updated
        try {
            renderTable(); // Initial render
            const tableHead = document.querySelector('#vehicleTable thead');
             if (tableHead) {
                 tableHead.addEventListener('click', handleSort);
             } else {
                 console.error("Table head #vehicleTable thead not found!");
                 showToast("Advertencia: Ordenamiento de tabla no disponible.", "warning");
             }
            showToast("Aplicación LEFIOS CARS cargada.", "info");
            console.log("App Initialized.");
        } catch (error) {
            console.error("CRITICAL ERROR during initialization:", error);
            showToast("Error crítico al iniciar. Revisa la consola.", "error");
             const container = document.querySelector('.container');
             if (container) {
                 const errorDiv = document.createElement('div');
                 errorDiv.style.cssText = 'color:red; border:2px solid red; padding:15px; margin-top:20px; background-color:#ffecec;';
                 errorDiv.innerHTML = '<strong>Error Crítico:</strong> La aplicación no pudo iniciarse correctamente. Los datos podrían no funcionar. Revisa la consola (F12) o recarga la página.';
                 container.insertBefore(errorDiv, container.firstChild);
             }
        }
    }

    // --- Run Initialization ---
    document.addEventListener('DOMContentLoaded', initializeApp);

  </script>
</body>
</html>
